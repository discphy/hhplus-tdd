# TDD

<!-- TOC -->
* [TDD](#tdd)
  * [μ”κµ¬μ‚¬ν•­](#μ”κµ¬μ‚¬ν•­)
    * [ν¬μΈνΈ μ¶©μ „](#ν¬μΈνΈ-μ¶©μ „)
    * [ν¬μΈνΈ μ‚¬μ©](#ν¬μΈνΈ-μ‚¬μ©)
    * [ν¬μΈνΈ μ΅°ν](#ν¬μΈνΈ-μ΅°ν)
    * [ν¬μΈνΈ λ‚΄μ—­ μ΅°ν](#ν¬μΈνΈ-λ‚΄μ—­-μ΅°ν)
  * [API λ¬Έμ„ μ‘μ„±](#api-λ¬Έμ„-μ‘μ„±-)
  * [λ™μ‹μ„± μ μ–΄ λ°©μ‹ λ° μ μ© μ¥λ‹¨μ  κΈ°μ  λ³΄κ³ μ„](#λ™μ‹μ„±-μ μ–΄-λ°©μ‹-λ°-μ μ©-μ¥λ‹¨μ -κΈ°μ -λ³΄κ³ μ„)
    * [λ™μ‹μ„± λ¬Έμ λ€?](#λ™μ‹μ„±-λ¬Έμ λ€)
    * [λ™μ‹μ„± λ¬Έμ  μ ν•](#λ™μ‹μ„±-λ¬Έμ -μ ν•)
    * [λ™μ‹μ„± ν•΄κ²° λ°©λ²•](#λ™μ‹μ„±-ν•΄κ²°-λ°©λ²•)
    * [λ™μ‹μ„± λ„κµ¬ μ μ©](#λ™μ‹μ„±-λ„κµ¬-μ μ©-)
    * [ν‚¤μ›λ“ μ •λ¦¬](#ν‚¤μ›λ“-μ •λ¦¬)
<!-- TOC -->

## μ”κµ¬μ‚¬ν•­

### ν¬μΈνΈ μ¶©μ „

+ [ ] μ¶©μ „ μ”μ²­κΈμ•΅μ€ 0λ³΄λ‹¤ μ»¤μ•Ό ν•λ‹¤.
+ [ ] ν¬μΈνΈ μ¶©μ „ μµλ€ κΈμ•΅μ€ 1000λ§μ› κΉμ§€λ‹¤.
+ [ ] κ°™μ€ μ‚¬μ©μκ°€ λ™μ‹μ— μ¶©μ „ν•  κ²½μ°, ν•΄λ‹Ή μ”μ²­ λ¨λ‘ μ •μƒμ΄μ—¬μ•Ό ν•¨.
+ [ ] μ”μ²­ν• μ¶©μ „κΈμ•΅μ„ μ¶©μ „ν•λ‹¤.
+ [ ] μ¶©μ „μ„ μ™„λ£ν•λ©΄ λ‚΄μ—­μ„ μ €μ¥ν•λ‹¤.

### ν¬μΈνΈ μ‚¬μ©

+ [ ] μ‚¬μ© μ”μ²­κΈμ•΅μ€ 0λ³΄λ‹¤ μ»¤μ•Όν•λ‹¤.
+ [ ] ν¬μΈνΈ μ‚¬μ© ν›„, μ”κ³ λ” 0μ΄ λ  μ μ—†λ‹¤.
+ [ ] κ°™μ€ μ‚¬μ©μκ°€ λ™μ‹μ— μ‚¬μ©ν•  κ²½μ°, ν•΄λ‹Ή μ”μ²­ λ¨λ‘ μ •μƒμ΄μ—¬μ•Ό ν•¨.
+ [ ] μ”μ²­ν• μ‚¬μ©κΈμ•΅μ„ μ‚¬μ©ν•λ‹¤.
+ [ ] μ‚¬μ©μ„ μ™„λ£ν•λ©΄ λ‚΄μ—­μ„ μ €μ¥ν•λ‹¤.

### ν¬μΈνΈ μ΅°ν

+ [ ] μ”μ²­ν• μ‚¬μ©μμ ν¬μΈνΈλ¥Ό μ΅°νν•λ‹¤.

### ν¬μΈνΈ λ‚΄μ—­ μ΅°ν

+ [ ] μ”μ²­ν• μ‚¬μ©μμ ν¬μΈνΈ λ‚΄μ—­μ„ λ‚΄λ¦Όμ°¨μμΌλ΅ μ •λ ¬ν•λ‹¤.

## API λ¬Έμ„ μ‘μ„± 

[API λ…μ„Έ](docs/Api.md)

## λ™μ‹μ„± μ μ–΄ λ°©μ‹ λ° μ μ© μ¥λ‹¨μ  κΈ°μ  λ³΄κ³ μ„

### λ™μ‹μ„± λ¬Έμ λ€?

μ—¬λ¬ μ¤λ λ“κ°€ λ™μ‹μ— κ³µμ  μμ›μ— μ ‘κ·Όν•κ±°λ‚ μμ •ν•λ ¤ ν•  λ• λ°μƒν•λ” λ¬Έμ λ¥Ό μ΄μ•ΌκΈ°ν•λ‹¤.

### λ™μ‹μ„± λ¬Έμ  μ ν•

**π Race Condition (κ²½μ μ΅°κ±΄)**

μ—¬λ¬ μ¤λ λ“κ°€ μμ„λ¥Ό μ μ–΄ν•μ§€ λ»ν•κ³  λ™μ‹μ— μμ›μ— μ ‘κ·Όν•  λ• λ°μƒν•λ©°, κ²°κ³Όκ°€ μ‹¤ν–‰ μμ„μ— λ”°λΌ λ‹¬λΌμ§„λ‹¤.   
μ›μμ„±κ³Ό κ°€μ‹μ„± λ¨λ‘ λ³΄μ¥λμ–΄μ•Ό ν•΄κ²°ν•  μ μλ‹¤.

> π’΅ **μ›μμ„± & κ°€μ‹μ„±**   
> 
> μ›μμ„± : κ³µμ  μμ›μ— λ€ν• μ‘μ—…μ λ‹¨μ„κ°€ λ” μ΄μƒ μΌκ°¤ μ μ—†λ” ν•λ‚μ μ—°μ‚°μ²λΌ λ™μ‘ν•λ” μ„±μ§μ„ μλ―Έ   
> κ°€μ‹μ„± : ν• μ¤λ λ“μ—μ„ λ³€κ²½ν• κ°’μ΄ λ‹¤λ¥Έ μ¤λ λ“μ—μ„ μ¦‰μ‹ ν™•μΈ κ°€λ¥ν• μ„±μ§μ„ μλ―Έ

```java
int count = 0;

/*
 * β μ—¬λ¬ μ¤λ λ“κ°€ λ™μ‹μ— increment()λ¥Ό νΈμ¶ν•λ©΄ μ‹¤ν–‰ μμ„μ— μν•΄ μµμΆ… κ°’μ΄ μμƒν• κ°’λ³΄λ‹¤ μ‘μ„ μ μλ” λ¬Έμ κ°€ λ°μƒν•λ‹¤.
 *
 * */
public void increment() {
    couunt++; // λ‚΄λ¶€μ μΌλ΅λ” Read-Modify-Write λ‹¨κ³„λ΅ μ‹¤ν–‰λλ‹¤. 
}
```

**π§© λ°μ΄ν„° λ¶μΌμΉ**

μ—¬λ¬ μ¤λ λ“κ°€ λ™μ‹μ— κ³µμ  μμ›μ„ μμ •ν•΄μ„ μ •ν•©μ„± μλ” κ²°κ³Όκ°€ λ³΄μ¥λμ§€ μ•μ

```java
long remainAmount = 10000;

/*
 * β μ—¬λ¬ μ¤λ λ“κ°€ λ™μ‹μ— μ¶κΈμ„ μ‹λ„ν•  λ•,
 * μ§€μ—°μΌλ΅ μΈν•΄ κ²€μ¦μ—λ” ν†µκ³Όν•κ³  μ¶κΈμ„ ν•λ” μƒν™©μ΄ λ°μƒν•μ—¬ μ”κ³ κ°€ μμκ°€ λ  μ μλ‹¤.
 *
 * */
public void withdraw(long withdrawAmount) {
    if (withdrawAmount > remainAmount) {
        throw new IllegalArgumentException("μ”κ³ κ°€ λ¶€μ΅±ν•©λ‹λ‹¤.");
    }

    Thread.sleep(1000); // μλ„μ μΌλ΅ μ§€μ—° λ°μƒ
    remainAmount = remainAmount - withdrawAmount;
}
```

**β›” λ°λ“λ½ - κµμ°©μƒνƒ (Deadlock)**

μ„λ΅κ°€ κ°€μ§„ λ½μ„ μƒλ€λ°©μ΄ μ”μ²­ ν•λ©΄μ„ λ¬΄ν• λ€κΈ° μƒνƒμ— λΉ μ§

---

> μ„ μ ν• μ΄μ™Έμ—λ„ λ™μ‹μ„±μ„ λ°©μΉν•λ©΄, λ™μ‹μ„± λ¬Έμ λ΅ μƒκΈ΄ ν•΄κ²°ν•κΈ° νλ“¤κ³  μ¶”μ μ΄ μ–΄λ ¤μ΄ λ²„κ·Έλ¥Ό λ§λ‚  μ μλ‹¤.

### λ™μ‹μ„± ν•΄κ²° λ°©λ²•

**1οΈβƒ£ synchronized**

μλ°” κΈ°λ³Έ λ™κΈ°ν™” ν‚¤μ›λ“λ΅, λ©”μ„λ“λ‚ μ½”λ“ λΈ”λ­μ— λ½μ„ κ±Έμ–΄ λ‹¨μΌ μ¤λ λ“λ§ μ§„μ…ν•  μ μλ„λ΅ μ ν•ν•λ‹¤. (λΈ”λ΅ν‚Ή λ°©μ‹)

[μμ ]

```java
private int count = 0;

public synchronized void increment() { // β… synchronized ν‚¤μ›λ“λ¥Ό μ‚¬μ©ν•΄ λ©”μ„λ“ λΈ”λ΅ λ™κΈ°ν™” μ μ–΄
    count++;
}
```

[μ¥μ ]

+ λ¬Έλ²•μ΄ κ°„λ‹¨ν•κ³  μ§κ΄€μ μ΄λ‹¤.

[λ‹¨μ ]

+ μ¤λ λ“ λ½μ΄ ν’€λ¦΄ λ•κΉμ§€ λ¬΄ν• λ€κΈ°ν•μ—¬ μ„±λ¥ μ €ν•μ— μν–¥μ„ λΌμΉλ‹¤.
+ κ³µμ •μ„± λ³΄μ¥μ΄ λμ§€ μ•μ•„ νΉμ • λ½μ΄ μ¤λκΈ°κ°„ λ™μ• λ½μ„ νλ“ν•μ§€ λ»ν•  μ μλ‹¤.

**2οΈβƒ£ ReentrantLock**

μ¬μ§„μ…μ΄ κ°€λ¥ν•κ³  μ΅°κ±΄ μ μ–΄λ‚ νƒ€μ„μ•„μ›ƒ, μΈν„°λ½νΈλ¥Ό ν†µν•΄ μ„Έλ°€ν•κ² λ™κΈ°ν™” μ μ–΄λ¥Ό ν•  μ μλ” λ½

[μμ ]
```java
private int count = 0;
private final ReentrantLock lock = new ReentrantLock();

public void increment() {
    lock.lock(); // β… ReentrantLockμ„ ν†µν• λ½ νλ“
    try {
        count++;
    } finally {
        lock.unlock(); // β… ReentrantLockμ„ ν†µν• λ½ ν•΄μ 
    }
}
```

[μ¥μ ]

+ μμ„λ¥Ό λ³΄μ¥ν•λ” κ³µμ •μ„± μ„¤μ •μ΄ κ°€λ¥ν•λ‹¤. 
+ μ„Έλ°€ν•κ² λ™κΈ°ν™”λ¥Ό μ μ–΄

[λ‹¨μ ]

+ μ½”λ“ λ³µμ΅λ„κ°€ μ¦κ°€ν•λ‹¤.

**3οΈβƒ£ volatile**

λ³€μμ κ°€μ‹μ„±μ„ λ³΄μ¥, CPU μΊμ‹λ¥Ό μ‚¬μ©ν•μ§€ μ•κ³  λ©”μΈ λ©”λ¨λ¦¬μ—μ„ μ§μ ‘ μ½λ”λ‹¤. 

[μμ ]
```java
private volatile boolean running = true;

public void stop() {
    running = false;
}

public void run() {
    while (running) { // β… μΊμ‹μ—μ„ μ½λ”κ² μ•„λ‹λΌ, μ§μ ‘ λ©”μΈ λ©”λ¨λ¦¬λ¥Ό μ½μ–΄ κ°€μ‹μ„±μ„ λ³΄μ¥ν•λ‹¤.
        // μ‘μ—… μν–‰
    }
}
```

[μ¥μ ]

+ λ§¤μ° κ°€λ³κ³  λΉ λ¥΄λ‹¤. 
+ ν”λκ·Έμ— μ ν•©ν•λ‹¤. 

[λ‹¨μ ]

+ μ›μμ„± λ³΄μ¥μ΄ λμ§€ μ•λ”λ‹¤. 

**4οΈβƒ£ Atomic ν΄λμ¤**

CAS(Compare-And-Set) μ•κ³ λ¦¬μ¦ κΈ°λ°μΌλ΅ μ›μμ„±μ„ λ³΄μ¥ν•λ©° λ½ μ—†μ΄ μ—°μ‚°μ΄ κ°€λ¥ν•λ‹¤. (λ…ΌλΈ”λ΅ν‚Ή λ°©μ‹)

[μμ ]
```java
private AtomicInteger count = new AtomicInteger(0);

public void increment() {
    count.incrementAndGet(); // β… λ½ μ—†μ΄ CAS κΈ°λ°μΌλ΅ μ›μμ„± μ—°μ‚°μ„ ν•λ‹¤.
}
```

[μ¥μ ] 

+ λ½μ΄ μ—†λ” μ—°μ‚°μΌλ΅ λ†’μ€ μ„±λ¥
+ λ°λ“λ½μ΄ μ—†λ‹¤. 
+ λ©€ν‹°μ¤λ λ“ ν™κ²½μ—μ„ μ•μ •μ μ΄λ‹¤.

[λ‹¨μ ]

+ λ‹¨μΌ λ³€μ μμ¤€μ—μ„λ§ ν¨κ³Όμ μ΄λ‹¤. 
+ λ³µμ΅ν• μ—°μ‚°μ—μ„λ” μ‚¬μ©ν•κΈ° μ–΄λ µλ‹¤.
+ λ°λ³µ μ‹¤ν¨λ΅ μΈν• μ§€μ—° λ°μƒ κ°€λ¥

**5οΈβƒ£ λ™μ‹μ„± μ»¬λ ‰μ…**

Thread Safeν• μλ°” μ»¬λ ‰μ…

```java
private Map<String, Integer> map = new ConcurrentHashMap<>(); // β… λ™μ‹μ„± μ»¬λ ‰μ…μΌλ΅ μΈμ¤ν„΄μ¤ν™” ν•΄μ„ μΌλ° Map λ¬Έλ²•κ³Ό λ™μΌν•κ² μ‚¬μ©ν•λ‹¤.

public void put(String key, int value) {
    map.put(key, value);
}

public int get(String key) {
    return map.getOrDefault(key, 0);
}
```

[μ¥μ ]

+ ν”„λ΅μ‹ μ»¬λ ‰μ…(Collections.synchronizedList() λ“±)κ³Ό λ‹¬λ¦¬ λ¬΄λ¶„λ³„ν•κ² λ½μ„ νλ“ν•μ§€ μ•μ•„ μ„±λ¥μ μΌλ΅ μ°μν•λ‹¤. 
+ λ‚΄λ¶€μ—μ„ λ™κΈ°ν™” μ²λ¦¬λ΅ μ½”λ“κ°€ κ°„κ²°ν•λ‹¤.

[λ‹¨μ ]

+ μ„±λ¥μ΄ μΌλ° μ»¬λ ‰μ…λ³΄λ‹¤ μΆ‹μ§€ μ•λ‹¤. 

---

> μ΄μ™Έμ—λ„ λ™μ‹μ„± λ„κµ¬κ°€ λ§μ΄ μκ³  λ™μ‹μ„± νλ¦„μ„ μ μ–΄ν•λ” ν΄λμ¤λ„ μλ‹¤.    

### λ™μ‹μ„± λ„κµ¬ μ μ© 

**"λ™μΌν• μ‚¬μ©μμ— λ€ν• λ™μ‹ μ”μ²­μ΄ μ •μƒμ μΌλ΅ μ²λ¦¬λ  μ μλ„λ΅ κ°μ„ "ν•λ” κ²ƒμ΄ μ”κµ¬μ‚¬ν•­μ΄λ‹¤.**

[μ„ νƒλ°›μ§€ λ»ν• λ™μ‹μ„± λ„κµ¬]

+ synchronized - π‘ : μ‚¬μ©μ κµ¬λ¶„ μ—†μ΄ λ‹¨μΌ μ¤λ λ“λ΅ λ™μ‘ν•κΈ° λ•λ¬Έμ— μ„±λ¥ μ €ν• μ΄μκ°€ μμ–΄ μ μ™Έν•μ€λ‹¤. 
+ volatile - π‘ : μ›μμ„±μ„ λ³΄μ¥ λ»ν•λ―€λ΅ μ μ™Έν•μ€λ‹¤.
+ Atomic ν΄λμ¤ - π¤” : `UserPointTable` ν΄λμ¤μ ν¬μΈνΈ λ³€μ νƒ€μ…μ„ Atomic ν΄λμ¤λ΅ λ€μ²΄ν•  μ μκ² μ§€λ§ μμ •μ΄ λ¶κ°€λ¥ν•λ‹¤λ” μ”κµ¬μ‚¬ν•­μ΄ μκΈ° λ•λ¬Έμ— μ μ™Έν•μ€λ‹¤. 

[μ„ νƒ]

μ μ € λ³„λ΅ `ReentrantLock`μ„ κ΄€λ¦¬ν•λ” λ™μ‹μ„± μ»¬λ ‰μ… `ConcurrentHashMap`μ„ μ‚¬μ©ν•μ—¬ κµ¬ν„μ„ μ§„ν–‰ν•μ€λ‹¤.

```java
private Map<Long, ReentrantLock> lockMap = new ConcurrentHashMap<>();

public void lock(long userId, Runnable runnable) {
    // β… μ‚¬μ©μ IDλ΅ λ™μ‹μ„± μ»¬λ ‰μ…μ—μ„ λ½μ„ κ°€μ Έμ¤λ” λ΅μ§μ΄λ‹¤. κ³µμ •λ¨λ“λ΅ μμ„λ¥Ό λ³΄μ¥ν•λ‹¤.  
    ReentrantLock reentrantLock = map.computeIfAbsent(id, k -> new ReentrantLock(true)); 

    reentrantLock.lock(); // π”’ λ½ νλ“
    try {
        runnable.run();
    } finally {
        reentrantLock.unlock(); // π”“ λ½ ν•΄μ 
    }
}
```

π”— λ™μ‹μ„± λ΅μ§ κµ¬ν„ μ»¤λ°‹ λ§ν¬ : [b662b64](https://github.com/discphy/hhplus-tdd/pull/2/commits/b662b64cb9aef3d29fb7db58dfdece56e4908400)

### ν‚¤μ›λ“ μ •λ¦¬

**λ™μ‹μ„± μ»¬λ ‰μ…μ΄ ν•­μƒ λ‹µμ€ μ•„λ‹λ‹¤.**

λ‹¨μΌ μ¤λ λ“κ°€ μ»¬λ ‰μ…μ„ μ‚¬μ©ν•λ” κ²½μ°μ—λ” λ™μ‹μ„± μ»¬λ ‰μ…μ΄ μ•„λ‹ μΌλ° μ»¬λ ‰μ…μ„ μ‚¬μ©ν•΄μ•Ό ν•λ‹¤. λ¶ν•„μ”ν• μ„±λ¥ μ €ν•λ¥Ό λ°μƒ μ‹ν‚¬ μ μλ‹¤. 

**λ™μ‹μ„± νλ¦„μ μ–΄ μλ°” ν‚¤μ›λ“**

+ CompletableFuture
+ ExecutorService
+ Flow

**μ™Έλ¶€ μ‹μ¤ν…μ„ ν™μ©ν• λ™μ‹μ„± μ μ–΄**

+ DBλ¥Ό ν™μ©ν• λΉ„κ΄€μ  λ½, λ‚™κ΄€μ  λ½
+ Redisλ¥Ό ν™μ©ν• λ¶„μ‚°λ½ 
+ Kafkaλ¥Ό ν™μ©ν• μμ°¨λ³΄μ¥ λ°©λ²•
